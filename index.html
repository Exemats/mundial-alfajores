<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mundial de Alfajores â€” Fijo (sin servidor)</title>
  <style>
    :root { --emerald:#10b981; --slate:#475569; --bg:#f1f5f9; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial; background:#f8fafc; color:#0f172a; }
    header{ position:sticky; top:0; z-index:10; background:rgba(255,255,255,.9); backdrop-filter:saturate(180%) blur(6px); border-bottom:1px solid #e2e8f0; }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    h1{ font-size:20px; margin:0; display:flex; gap:10px; align-items:center; }
    .chip{ display:inline-flex; align-items:center; gap:6px; border:1px solid #e2e8f0; padding:4px 8px; border-radius:999px; background:#fff; font-size:12px; color:#64748b; }
    .panel{ background:#fff; border:1px solid #e2e8f0; border-radius:16px; padding:16px; box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .grid{ display:grid; gap:12px; }
    .grid-2{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    .auto{ grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); }
    .btn{ border:1px solid #cbd5e1; background:#fff; padding:8px 12px; border-radius:12px; font-weight:600; cursor:pointer; }
    .btn.primary{ background:var(--emerald); color:#fff; border-color:#059669; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    input,select,textarea{ width:100%; padding:8px 10px; border:1px solid #cbd5e1; border-radius:10px; }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    th,td{ padding:8px 10px; border-bottom:1px solid #e2e8f0; text-align:center; }
    th:first-child,td:first-child{ text-align:left; }
    .pill{ border-radius:999px; border:1px solid #e2e8f0; padding:4px 10px; font-size:12px; background:#fff; }
    .muted{ color:#64748b; font-size:12px; }
    .tag{ display:inline-block; width:10px; height:10px; border-radius:4px; margin-right:6px; vertical-align:middle; }
    .card{ display:flex; gap:10px; align-items:center; border:1px solid #e2e8f0; border-radius:12px; padding:8px; background:#fff; }
    .thumb{ width:40px; height:40px; border-radius:8px; object-fit:cover; background:#e2e8f0; }
    .thumb-lg{ width:56px; height:56px; border-radius:10px; object-fit:cover; background:#e2e8f0; }
    .footer{ display:flex; justify-content:space-between; align-items:center; margin-top:16px; }
    .ok{ color:#065f46; font-size:12px; }
    .warn{ color:#b91c1c; font-size:12px; }
    .grid-cards{ display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); }
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between;">
      <h1>ðŸ¥® Mundial de Alfajores <span class="chip" id="phaseChip">Registro</span></h1>
      <div class="muted">Lista fija (16) Â· Grupos con decimales Â· Semis/Final por elecciÃ³n</div>
    </div>
  </header>

  <main class="wrap" style="padding-bottom:60px;">
    <!-- Registro (participantes fijos + evaluadores) -->
    <section id="view-registro" class="grid" style="margin-top:12px;">
      <div class="panel grid">
        <div class="row" style="justify-content:space-between;">
          <b>Alfajores participantes</b>
          <span class="muted">Lista fija â€” no editable</span>
        </div>
        <div id="pList" class="grid-cards"></div>

        <hr/>
        <b>Evaluadores / Jurado</b>
        <div class="grid grid-3">
          <input id="eNombre" placeholder="Nombre del evaluador" />
          <button class="btn" id="btnAddE">Agregar evaluador</button>
          <span class="muted" id="evalCount"></span>
        </div>
        <div id="eList" class="row"></div>

        <div class="footer">
          <span class="muted" id="pStatus"></span>
          <div class="row">
            <button class="btn primary" id="btnGoGroups" disabled>Ir a Fase de grupos</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <b>Reglamento</b>
        <ul>
          <li>16 â†’ 4 grupos de 4.</li>
          <li>Grupos: cada evaluador puntÃºa de 1 a 10 con <b>decimales</b>. Orden por <b>promedio</b>, tiebreak por <i>mediana</i> y cantidad de <i>10s</i>.</li>
          <li>Avanza el 1Âº de cada grupo a Semis.</li>
          <li>Semis y Final: <b>elecciÃ³n directa</b> (sin puntajes).</li>
        </ul>
      </div>
    </section>

    <!-- Grupos -->
    <section id="view-grupos" class="grid" style="display:none; margin-top:12px;"></section>

    <!-- Semis -->
    <section id="view-semis" class="grid" style="display:none; margin-top:12px;"></section>

    <!-- Final -->
    <section id="view-final" class="grid" style="display:none; margin-top:12px;"></section>

    <!-- CampeÃ³n -->
    <section id="view-campeon" class="grid" style="display:none; margin-top:12px;"></section>

    <div class="footer">
      <span class="muted">Modo sin servidor Â· Guardado local (localStorage)</span>
      <div class="row">
        <button class="btn" id="btnExport">Exportar CSV</button>
        <button class="btn" id="btnReset">Reiniciar torneo</button>
      </div>
    </div>
  </main>

  <script>
    // =============== Datos fijos ==================
    const FIXED_BRANDS = [
      { marca: "Cachafaz", photo: "https://elnenearg.vtexassets.com/arquivos/ids/162359/ALFAJOR-CACHAFAZ-NEGRO-X60GR-1-9173.jpg?v=637971142874470000" },
      { marca: "Rasta", photo: "https://acdn-us.mitiendanube.com/stores/001/185/658/products/rastanegro-f0c2decae45778a8e617150148107173-640-0.jpg" },
      { marca: "Block", photo: "https://arjosimarprod.vtexassets.com/arquivos/ids/156289/cofler-block-alfajor-1clasico-60gr-1-971.jpg?v=637387318529270000" },
      { marca: "Milka Mousse", photo: "https://ferniplastar.vtexassets.com/arquivos/ids/6012351/Alfajor-Milka-Mousse-42G.jpg?v=638878641446600000" },
      { marca: "Oreo", photo: "https://http2.mlstatic.com/D_NQ_NP_754491-MLU70696877825_072023-O.webp" },
      { marca: "Tita", photo: "https://http2.mlstatic.com/D_NQ_NP_861007-MLA76473483009_052024-O.webp" },
      { marca: "CapitÃ¡n del Espacio", photo: "https://www.capitandelespaciomr.com.ar/Prueba/capitan/images/pic1.png" },
      { marca: "Vauquita", photo: "https://http2.mlstatic.com/D_NQ_NP_968050-MLU79311813463_092024-O.webp" },
      { marca: "Pepitos", photo: "https://http2.mlstatic.com/D_NQ_NP_998442-MLA43106367276_082020-O.webp" },
      { marca: "Aguila mini torta brownie", photo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQLF67wVpUtd243EJLUvutoHjemLH52vnvNgA&s" },
      { marca: "Fantoche", photo: "https://www.fantoche.com.ar/assets/images/productos/triplenegro.png" },
      { marca: "Fulbito", photo: "https://http2.mlstatic.com/D_NQ_NP_895461-MLA76008036712_052024-O.webp" },
      { marca: "Jorgito", photo: "https://www.cucinare.tv/wp-content/uploads/2020/07/Jorgito.jpg" },
      { marca: "Terrabusi triple", photo: "https://www.farmaciassanchezantoniolli.com.ar/13210-medium_default/terrabusi-alfajor-triple-cl%C3%A1sico-x-70g.jpg" },
      { marca: "Bon o Bon", photo: "https://arcorencasa.com/wp-content/uploads/2024/10/20241008-4303.webp" },
      { marca: "B&N Bagley", photo: "https://statics.dinoonline.com.ar/imagenes/full_600x600_ma/2182006_f.jpg" },
    ].map((x)=>({ id: slug(x.marca), ...x, color: pastel() }));

    // =============== Estado / storage ===============
    const KEY = 'mundial_alfajores_fixed_v1';
    const initial = {
      phase: 'registro',
      participants: FIXED_BRANDS, // fijo
      evaluators: [],            // {id,nombre}
      groups: [],               // [{name:'A', teamIds:[..], scores:{ teamId: { evaluatorId: number } }}]
      semis: [],                // [{id,homeId,awayId,winnerId?}]
      finalMatch: null,         // {id,homeId,awayId,winnerId?}
      championId: null,
    };

    let state = load() || initial;

    function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
    function load(){ try { const s = JSON.parse(localStorage.getItem(KEY)); if(!s) return null; // asegurar lista fija
      s.participants = FIXED_BRANDS; return s; } catch { return null; } }
    function uid(){ return Math.random().toString(36).slice(2,10); }
    function slug(s){ return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
    function pastel(){ const hues=[140,160,180,200,220,260,300,20,40]; const h=hues[Math.floor(Math.random()*hues.length)]; return `hsl(${h} 65% 78%)`; }

    // =============== Helpers numÃ©ricos ===============
    const defined = x => x!==undefined && x!==null && x!=='';
    const clampScore = v => !defined(v) ? undefined : Math.max(1, Math.min(10, Number(v)));
    const avg = arr => !arr.length ? NaN : arr.reduce((a,b)=>a+b,0)/arr.length;
    const median = arr => { if(!arr.length) return NaN; const a=[...arr].sort((x,y)=>x-y); const m=Math.floor(a.length/2); return a.length%2?a[m]:(a[m-1]+a[m])/2; }
    const countTens = arr => arr.filter(v=>Number(v)===10).length;
    const fmt = x => Number.isFinite(x) ? Number(x).toFixed(2) : 'â€”';

    // =============== DOM refs ===============
    const phaseChip = document.getElementById('phaseChip');
    const pList = document.getElementById('pList');
    const eNombre = document.getElementById('eNombre');
    const btnAddE = document.getElementById('btnAddE');
    const eList = document.getElementById('eList');
    const evalCount = document.getElementById('evalCount');
    const pStatus = document.getElementById('pStatus');
    const btnGoGroups = document.getElementById('btnGoGroups');

    const viewRegistro = document.getElementById('view-registro');
    const viewGrupos = document.getElementById('view-grupos');
    const viewSemis = document.getElementById('view-semis');
    const viewFinal = document.getElementById('view-final');
    const viewCampeon = document.getElementById('view-campeon');

    const btnReset = document.getElementById('btnReset');
    const btnExport = document.getElementById('btnExport');

    // =============== Init UI ===============
    function init(){
      btnAddE.onclick = () => { const nombre = eNombre.value.trim(); if(!nombre) return; state.evaluators.push({ id: uid(), nombre }); eNombre.value=''; save(); render(); };
      btnReset.onclick = () => { if(confirm('Â¿Reiniciar todo?')) { state = JSON.parse(JSON.stringify(initial)); save(); render(); } };
      btnGoGroups.onclick = () => { if(btnGoGroups.disabled) return; makeGroups(); state.phase = 'grupos'; save(); render(); };
      btnExport.onclick = () => exportCSV();
      render();
    }

    function render(){
      phaseChip.textContent = state.phase.charAt(0).toUpperCase()+state.phase.slice(1);
      // participantes fijos
      pList.innerHTML = state.participants.map((p,i)=>`<div class="card"><img class="thumb" src="${esc(p.photo||'')}" alt="${esc(p.marca)}"/><div><div><b>${i+1}. ${esc(p.marca)}</b></div></div></div>`).join('');
      // evaluadores
      evalCount.textContent = `${state.evaluators.length} cargados`;
      eList.innerHTML = state.evaluators.map(e=>`<span class="pill">${esc(e.nombre)} <a href="#" onclick="removeE('${e.id}')" style="margin-left:8px; color:#64748b;">Ã—</a></span>`).join(' ');

      pStatus.textContent = `Evaluadores: ${state.evaluators.length}`;
      btnGoGroups.disabled = !(state.evaluators.length>0);

      show(viewRegistro, state.phase==='registro');
      show(viewGrupos, state.phase==='grupos');
      show(viewSemis, state.phase==='semis');
      show(viewFinal, state.phase==='final');
      show(viewCampeon, state.phase==='campeon');

      if (state.phase==='grupos') renderGroups();
      if (state.phase==='semis') renderSemis();
      if (state.phase==='final') renderFinal();
      if (state.phase==='campeon') renderChampion();
    }
    function show(el,on){ el.style.display = on?'grid':'none'; }

    window.removeE = (id) => { state.evaluators = state.evaluators.filter(e=>e.id!==id); save(); render(); }

    // =============== Fase de grupos ===============
    function makeGroups(){
      const size = 4; // fijo 16
      const shuffled = [...state.participants].sort(()=>Math.random()-0.5);
      const chunks = [shuffled.slice(0,size), shuffled.slice(size,size*2), shuffled.slice(size*2,size*3), shuffled.slice(size*3,size*4)];
      const names = ['A','B','C','D'];
      state.groups = chunks.map((chunk,i)=>({ name:names[i], teamIds: chunk.map(t=>t.id), scores: Object.fromEntries(chunk.map(t=>[t.id,{}])) }));
    }

    function computeGroupTable(g){
      const rows = g.teamIds.map(id=>{
        const vals = Object.values(g.scores[id]||{}).filter(v=>defined(v)).map(Number);
        return { id, avg: avg(vals), median: median(vals), count: vals.length, tens: countTens(vals) };
      });
      rows.sort((a,b)=> (b.avg-a.avg) || (b.median-a.median) || (b.tens-a.tens) || brandById(a.id).localeCompare(brandById(b.id)) );
      return rows;
    }
    function brandById(id){ return (state.participants.find(p=>p.id===id)||{}).marca || ''; }
    function teamById(id){ return state.participants.find(p=>p.id===id); }

    function renderGroups(){
      viewGrupos.innerHTML = '';
      const grid = document.createElement('div'); grid.className='grid grid-2';
      state.groups.forEach(g=>{
        const card = document.createElement('div'); card.className='panel grid';
        card.innerHTML = `<div class="row" style="justify-content:space-between;"><b>Grupo ${g.name}</b><span class="muted">${g.teamIds.length} alfajores Â· ${state.evaluators.length} evaluadores</span></div>`;

        const tbl = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `<tr><th>Alfajor</th>${state.evaluators.map(e=>`<th>${esc(e.nombre)}</th>`).join('')}<th>Prom.</th><th>Mediana</th></tr>`;
        tbl.appendChild(thead);
        const tbody = document.createElement('tbody');
        g.teamIds.forEach(tid=>{
          const tr = document.createElement('tr');
          const t = teamById(tid);
          tr.innerHTML = `<td><img class="thumb" src="${esc(t.photo||'')}" alt="${esc(t.marca)}"/> <b>${esc(t.marca)}</b></td>`;
          state.evaluators.forEach(ev=>{
            const td = document.createElement('td');
            const inp = document.createElement('input');
            inp.type='number'; inp.min=1; inp.max=10; inp.step=0.1; inp.style.width='80px';
            const v = g.scores[tid]?.[ev.id]; inp.value = defined(v)? v : '';
            inp.oninput = () => { const val = clampScore(inp.value); if(!defined(g.scores[tid])) g.scores[tid]={}; g.scores[tid][ev.id]=val; save(); renderGroups(); };
            td.appendChild(inp); tr.appendChild(td);
          });
          const avgCell = document.createElement('td');
          const medCell = document.createElement('td');
          const vals = Object.values(g.scores[tid]||{}).filter(v=>defined(v)).map(Number);
          avgCell.textContent = fmt(avg(vals)); medCell.textContent = fmt(median(vals));
          tr.appendChild(avgCell); tr.appendChild(medCell);
          tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        card.appendChild(tbl);

        const rows = computeGroupTable(g);
        const table2 = document.createElement('table');
        table2.innerHTML = `<thead><tr><th>Equipo</th><th>Prom.</th><th>Mediana</th><th>#Votos</th><th>#10s</th></tr></thead>`;
        const tb2 = document.createElement('tbody');
        rows.forEach(r=>{
          const t = teamById(r.id);
          const tr = document.createElement('tr');
          tr.innerHTML = `<td><img class="thumb" src="${esc(t.photo||'')}" alt="${esc(t.marca)}"/> ${esc(t.marca)}</td><td><b>${fmt(r.avg)}</b></td><td>${fmt(r.median)}</td><td>${r.count}</td><td>${r.tens}</td>`;
          tb2.appendChild(tr);
        });
        table2.appendChild(tb2);
        const winner = rows[0] ? teamById(rows[0].id) : null;
        const winDiv = document.createElement('div'); winDiv.className='muted'; winDiv.style.marginTop='6px';
        winDiv.innerHTML = `Avanza: <b>${winner? esc(winner.marca): 'â€”'}</b>`;
        card.appendChild(document.createElement('hr'));
        card.appendChild(table2);
        card.appendChild(winDiv);
        grid.appendChild(card);
      });
      viewGrupos.appendChild(grid);

      const allHaveAny = state.groups.every(g=> g.teamIds.every(id=> Object.values(g.scores[id]||{}).some(v=>defined(v)) ));
      const footer = document.createElement('div'); footer.className='row'; footer.style.justifyContent='flex-end';
      const next = document.createElement('button'); next.className='btn primary'; next.textContent='Avanzar a Semifinales'; next.disabled = !allHaveAny;
      next.onclick = () => { if(!next.disabled){ makeSemis(); state.phase='semis'; save(); render(); } };
      footer.appendChild(next); viewGrupos.appendChild(footer);
    }

    // =============== Semifinales / Final (elecciÃ³n directa) ===============
    function pickGroupWinner(g){ return computeGroupTable(g)[0]?.id; }
    function makeSemis(){
      const map = Object.fromEntries(state.groups.map(g=>[g.name,g]));
      const A = pickGroupWinner(map['A']);
      const B = pickGroupWinner(map['B']);
      const C = pickGroupWinner(map['C']);
      const D = pickGroupWinner(map['D']);
      state.semis = [ { id: uid(), homeId:A, awayId:D, winnerId:null }, { id: uid(), homeId:B, awayId:C, winnerId:null } ];
    }

    function renderSemis(){
      viewSemis.innerHTML = '';
      const grid = document.createElement('div'); grid.className='grid grid-2';
      state.semis.forEach((m,i)=>{
        const card = document.createElement('div'); card.className='panel';
        const h = teamById(m.homeId), a = teamById(m.awayId);
        card.innerHTML = `<div class="muted" style="margin-bottom:6px;">Semifinal ${i+1}</div>`;
        const row = document.createElement('div'); row.className='grid grid-2';
        [h,a].forEach(t=>{
          const b = document.createElement('button'); b.className='btn'; b.style.display='flex'; b.style.alignItems='center'; b.style.gap='8px'; b.style.padding='10px 12px'; b.style.textAlign='left'; b.style.borderRadius='12px'; b.style.border='1px solid #cbd5e1';
          if (m.winnerId===t.id){ b.style.background='#ecfdf5'; b.style.borderColor='#10b981'; }
          const img = document.createElement('img'); img.className='thumb-lg'; img.src=t.photo||''; img.alt=t.marca;
          const span = document.createElement('span'); span.textContent = t.marca; span.style.fontWeight='600';
          b.appendChild(img); b.appendChild(span);
          b.onclick = ()=>{ m.winnerId = t.id; save(); renderSemis(); };
          row.appendChild(b);
        });
        card.appendChild(row);
        if (m.winnerId){ const choose = document.createElement('div'); choose.className='ok'; choose.style.marginTop='6px'; choose.innerHTML = `Elegido: <b>${esc(teamById(m.winnerId).marca)}</b>`; card.appendChild(choose); }
        grid.appendChild(card);
      });
      viewSemis.appendChild(grid);

      const ready = state.semis.every(m=>!!m.winnerId);
      const foot = document.createElement('div'); foot.className='row'; foot.style.justifyContent='flex-end';
      const next = document.createElement('button'); next.className='btn primary'; next.textContent='Armar Final'; next.disabled=!ready;
      next.onclick = ()=>{ if(!next.disabled){ const w = state.semis.map(m=>m.winnerId); state.finalMatch = { id: uid(), homeId:w[0], awayId:w[1], winnerId:null }; state.phase='final'; save(); render(); } };
      foot.appendChild(next); viewSemis.appendChild(foot);
    }

    function renderFinal(){
      viewFinal.innerHTML = '';
      const m = state.finalMatch; if (!m){ viewFinal.innerHTML = '<div class="panel">No hay final aÃºn.</div>'; return; }
      const card = document.createElement('div'); card.className='panel';
      const wrap = document.createElement('div'); wrap.className='grid grid-2';
      [teamById(m.homeId), teamById(m.awayId)].forEach(t=>{
        const b = document.createElement('button'); b.className='btn'; b.style.display='flex'; b.style.alignItems='center'; b.style.gap='8px'; b.style.padding='12px'; b.style.textAlign='left'; b.style.borderRadius='12px'; b.style.border='1px solid #cbd5e1';
        if (m.winnerId===t.id){ b.style.background='#ecfdf5'; b.style.borderColor='#10b981'; }
        const img = document.createElement('img'); img.className='thumb-lg'; img.src=t.photo||''; img.alt=t.marca;
        const span = document.createElement('span'); span.textContent = t.marca; span.style.fontWeight='700';
        b.appendChild(img); b.appendChild(span);
        b.onclick = ()=>{ m.winnerId = t.id; save(); renderFinal(); };
        wrap.appendChild(b);
      });
      card.appendChild(wrap);
      if (m.winnerId){ const choose = document.createElement('div'); choose.className='ok'; choose.style.marginTop='6px'; choose.innerHTML = `Elegido: <b>${esc(teamById(m.winnerId).marca)}</b>`; card.appendChild(choose); }
      const foot = document.createElement('div'); foot.className='row'; foot.style.justifyContent='flex-end'; foot.style.marginTop='8px';
      const btn = document.createElement('button'); btn.className='btn primary'; btn.textContent='Coronar CampeÃ³n'; btn.disabled=!m.winnerId;
      btn.onclick = ()=>{ if(m.winnerId){ state.championId = m.winnerId; state.phase='campeon'; save(); render(); } };
      foot.appendChild(btn); card.appendChild(foot);
      viewFinal.appendChild(card);
    }

    function renderChampion(){
      const champ = teamById(state.championId);
      viewCampeon.innerHTML = `<div class='panel' style='text-align:center;'>
        <div class='ok' style='text-transform:uppercase; letter-spacing:.06em;'>Â¡CampeÃ³n del Mundial de Alfajores!</div>
        <div style='font-size:28px; font-weight:800; margin-top:8px;'>ðŸ¥‡ ${champ? esc(champ.marca):'â€”'}</div>
        <div style='margin-top:10px;'>${champ? `<img src='${esc(champ.photo||'')}' alt='${esc(champ.marca)}' style='width:160px;height:160px;object-fit:cover;border-radius:14px;border:1px solid #e2e8f0;'/>` : ''}</div>
        <div style='margin-top:16px;'><button class='btn' onclick="resetTournament()">Empezar un nuevo torneo</button></div>
      </div>`;
    }

    window.resetTournament = function(){ if (confirm('Â¿Reiniciar todo el torneo?')) { state = JSON.parse(JSON.stringify(initial)); save(); render(); } }

    // =============== Export CSV ===============
    function exportCSV(){
      const lines = [];
      const quote = s => '"' + String(s).replace(/"/g,'""') + '"';
      lines.push(['Seccion','Grupo','Marca','Promedio','Mediana','Votos','Dieces'].map(quote).join(','));
      (state.groups||[]).forEach(g => {
        const rows = computeGroupTable(g);
        rows.forEach(r => {
          lines.push(['Grupos', g.name, brandById(r.id), fmt(r.avg), fmt(r.median), r.count, r.tens].map(quote).join(','));
        });
      });
      if (state.semis?.length){
        state.semis.forEach((m,i)=>{ lines.push(['Semifinal', i+1, brandById(m.winnerId||''), '', '', '', ''].map(quote).join(',')); });
      }
      if (state.finalMatch){ lines.push(['Final', '', brandById(state.finalMatch.winnerId||''), '', '', '', ''].map(quote).join(',')); }
      if (state.championId){ lines.push(['Campeon', '', brandById(state.championId||''), '', '', '', ''].map(quote).join(',')); }
      const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='mundial-alfajores.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // =============== Utils ===============
    function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // start
    init();
  </script>
</body>
</html>
